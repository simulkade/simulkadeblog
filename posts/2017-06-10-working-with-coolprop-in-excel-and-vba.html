<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Working with CoolProp in Excel (and vba) | SIMULKADE</title>
<link href="../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://simulkade.com/posts/2017-06-10-working-with-coolprop-in-excel-and-vba.html">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'center', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script><!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="AA Eftekhari">
<link rel="prev" href="starting-with-reaktoro.html" title="Starting with Reaktoro" type="text/html">
<meta property="og:site_name" content="SIMULKADE">
<meta property="og:title" content="Working with CoolProp in Excel (and vba)">
<meta property="og:url" content="http://simulkade.com/posts/2017-06-10-working-with-coolprop-in-excel-and-vba.html">
<meta property="og:description" content="CoolProp is a very useful package for the calculation of the physical (transport and thermodynamic) properties of pure fluids and mixtures. Usually, I call it from Julia or Python, but when it comes t">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-06-10T12:29:44+02:00">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        <div class="sidebar-item">
            <p>Theme by <a href="https://twitter.com/mdo" target="_blank">@mdo</a> and <a href="https://twitter.com/ralsina" target="_blank">@ralsina</a></p>
        </div>
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="http://www.simulkade.com/stories/about.html">About</a>
        <a class="sidebar-nav-item" href="http://fvt.simulkade.com">FVT</a>
        <a class="sidebar-nav-item" href="http://energy.simulkade.com">Energy</a>
        <a class="sidebar-nav-item" href="http://dailynote.simulkade.com">Daily</a>
        <a class="sidebar-nav-item" href="http://persian.simulkade.com">فارسی</a>
        <a class="sidebar-nav-item" href="../archive.html">Archive</a>
        <a class="sidebar-nav-item" href="../categories/index.html">Tags</a>
        <a class="sidebar-nav-item" href="../rss.xml">RSS feed</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="http://simulkade.com/" title="SIMULKADE" rel="home">SIMULKADE</a>
    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="post-title p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Working with CoolProp in Excel (and vba)</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">AA Eftekhari</span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="post-date published dt-published" datetime="2017-06-10T12:29:44+02:00" itemprop="datePublished" title="2017-06-10 12:29">2017-06-10 12:29</time></a></p>
                <p class="commentline">
        
    <a href="2017-06-10-working-with-coolprop-in-excel-and-vba.html#disqus_thread" data-disqus-identifier="cache/posts/2017-06-10-working-with-coolprop-in-excel-and-vba.html">Comments</a>


        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p><a href="http://www.coolprop.org">CoolProp</a> is a very useful package for the calculation of the physical (transport and thermodynamic) properties of pure fluids and mixtures. Usually, I call it from Julia or Python, but when it comes to communication with colleagues, they often prefer an excel file. I must confess, excel is not my cup of tea and I constantly make mistakes. Even when everything works fine, I suddenly run into a problem that can be solved way easier using a Python/Julia script. I'm not saying excel is a weak or bad tool; I'm just saying other tools are better!<br>
Few months ago, I calculated the pressure drop of a CO2 transport pipeline and the amount of compression work that is required for the gas transport. For the pressure drop, I used the Weymouth correlation. I first calculated the isentropic work of a compressor and then divided it by the mechanical efficiency of a centrifugal compressor to estimate the real power requirement. I assumed a multi-stage compressor with inter-stage cooling and a maximum compression ratio of three to three and a half. This is something that can be probably done in an excel sheet, but can be done much easier with a few lines of code. The same hold for the calculation pf pressure drop. Gas is compressible, and as the pressure drops in the pipeline, gas expands and it linear velocity increases. Therefore, the pressure drop needs to be calculated in short segments of the pipe, where we can assume the physical properties of the gas phase are constant. This segment based calculations although fits into an excel sheet, is not something that we need to see in detail. We are only interested in the pressure drop in the whole pipeline, not in every little segment.<br>
This encouraged me to overcome my excel-phobia and dive into it by writing two macros for the calculation of pressure drop in a gas pipeline and the power requirement in a compressor. I did not document the procedure, but I try my best to repeat it here with all the details.  Here's the (main part of) formulation:
$$W_{comp} = H(T(S_{out}, p_{out}), p_{out}) - H(T_{in}, p_{in})$$
The above equation means that the compression process is reversible, so we can calculate the temperature of the compressed gas, assuming that its entropy is equal to the entropy of the input gas stream.  </p>
<h4>Requirements</h4>
<p>A windows machine (or a windows virtual machine like mine) with Microsoft Excel installed.</p>
<h4>Step 1: install CoolProp for Windows</h4>
<p>Go to <a href="https://sourceforge.net/projects/coolprop/files/CoolProp/6.1.0/Installers/Windows/">this web page</a> and download the CoolProp installer (a file called <code>CoolProp_v6.1.0.0.exe</code>). I worked with version 6.1.0. You can alternatively download the latest version from <a href="https://sourceforge.net/projects/coolprop/files/CoolProp/nightly/Installers/Windows/">here</a>. I installed it with all the default settings. You may want to do the same.</p>
<h4>Step 2: test your installation</h4>
<p>CoolProp installer copies a test excel file called <code>TestExcel.xlsx</code> on your desktop. Open it and make sure that it works fine. By fine, I mean this screen-shot:
<img alt="coolprop sample calculation excel" src="../coolprop-sample-calc.png">
If it doesn't work and you cannot see the numbers, go to the <code>Installation</code> sheet in the same excel file and follow the instructions.</p>
<h4>Step 3: start writing a VBA function</h4>
<p>Create a new excel workbook. Then press <code>Alt + F11</code> to open the Microsoft Visual Basic for Applications. You will see something like this:
<img alt="visual basic excel coolprop" src="../vba-excel.png">
Right click on <code>VBAProject (Book1)</code> and choose Insert -&gt; Module:
<img alt="new-module-vba-coolprop" src="../vba-new-module-coolprop.png">
Before writing your new function in the module, you need to tell excel that you are going to call CoolProp functions. To do that, go to <code>Tools -&gt; References...</code> and check the box next to <code>CoolProp</code> like the following and then press OK.
<img alt="reference coolprop vba" src="../reference-coolprop-vba.png"></p>
<h4>Step 4: Write your function</h4>
<p>This is the function I have written for the calculation of the compression work. The inputs are number of compression stages (<code>n_stage</code>), the temperature in Kelvin after the inter-cooling stage (<code>T_comp</code>), input and output pressure for each compressor in Pascal (<code>p_in</code> and <code>p_out</code>), and <code>gas_type</code> which is the name of the fluid, e.g., "CO2". Copy and paste the function into your new module.</p>
<pre class="code literal-block"><span></span>Function comp_work(n_stage, T_comp, p_in, p_out, gas_type)
w_min_transport = 0#
comp_ratio = Exp(Log(p_out / p_in) / n_stage)
p_comp = p_in
p_comp_next = comp_ratio * p_comp
  For i = 1 To n_stage
    S_in = CoolProp.PropsSI("SMOLAR", "T", T_comp, "P", p_comp, gas_type) ' molar entropy J/(mol.K)
    H_in = CoolProp.PropsSI("HMOLAR", "T", T_comp, "P", p_comp, gas_type) ' molar enthalpy J/mol
    ' find the output T for isentropic compressor
    ' S_in-CoolProp.PropsSI("SMOLAR", "T", T_comp, "P", p_out, gas_type)
    T_out = CoolProp.PropsSI("T", "SMOLAR", S_in, "P", p_comp_next, gas_type)
    H_out = CoolProp.PropsSI("HMOLAR", "T", T_out, "P", p_comp_next, gas_type) ' molar enthalpy J/mol
    w_min_transport = w_min_transport + H_out - H_in ' J/mol
    p_comp = p_comp_next
    p_comp_next = p_comp * comp_ratio
  Next i
comp_work = w_min_transport
End Function
</pre>


<h4>Step 5: test your new function</h4>
<p>The (macro-enabled) excel file contains the vba code and a simple test, can be downloaded <a href="../compression_coolprop_test.xlsm">here</a>; the final results should look like this:
<img alt="test excel vba coolprop" src="../compression_test_coolprop.png"></p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="starting-with-reaktoro.html" rel="prev" title="Starting with Reaktoro">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="simulkade",
            disqus_url="http://simulkade.com/posts/2017-06-10-working-with-coolprop-in-excel-and-vba.html",
        disqus_title="Working with CoolProp in Excel (and vba)",
        disqus_identifier="cache/posts/2017-06-10-working-with-coolprop-in-excel-and-vba.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="simulkade";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2018         <a href="mailto:a.a.eftekhari@outlook.com">AA Eftekhari</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51207335-1', 'auto');
  ga('send', 'pageview');

</script><script src="../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
